@page "/contact"
@using DentalCLinic.Models
@using Microsoft.JSInterop
@inject IJSRuntime JS

<PageTitle>Contact Us - Oceanside Dental Centre</PageTitle>

<div class="row bg-ocean-gradient text-white py-3 mb-5">
    <div class="container">
        <div class="col-12 text-center">
            <h1 class="h3 m-0">Contact Us</h1>
        </div>
    </div>
</div>

<div class="container mb-5">
    <div class="row">
        <!-- Contact Info & Map -->
        <div class="col-lg-5 mb-4">
            <!-- Our Office Card -->
            <div class="card border-0 shadow-sm mb-4">
                <div class="card-header bg-ocean-gradient text-white py-2">
                    <h2 class="h5 m-0 text-center">Our Office</h2>
                </div>
                <div class="card-body">
                    <address class="mb-0">
                        <strong class="d-block mb-2 text-aqua">Oceanside Dental Centre</strong>
                        <div class="d-flex mb-2">
                            <span class="material-icons text-aqua me-2">location_on</span>
                            <span>
                                175 Corfield St S<br>
                                Parksville, BC V9P 2G1
                            </span>
                        </div>
                        <div class="d-flex mb-2">
                            <span class="material-icons text-aqua me-2">phone</span>
                            <span>250.586.4404</span>
                        </div>
                        <div class="d-flex mb-2">
                            <span class="material-icons text-aqua me-2">print</span>
                            <span>250.586.1287</span>
                        </div>
                        <div class="d-flex">
                            <span class="material-icons text-aqua me-2">email</span>
                            <a href="mailto:info@oceansidedentalcentre.com" class="text-decoration-none text-body">info@oceansidedentalcentre.com</a>
                        </div>
                    </address>
                </div>
            </div>

            <!-- Office Hours Card -->
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-ocean-gradient text-white py-2">
                   <h2 class="h5 m-0 text-center">Office Hours</h2>
                </div>
                <div class="card-body p-0">
                    <ul class="list-group list-group-flush">
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            <span>Monday</span> <span>8:00 AM - 4:00 PM</span>
                        </li>
                        <li class="list-group-item d-flex justify-content-between align-items-center bg-light">
                            <span>Tuesday</span> <span>8:00 AM - 4:00 PM</span>
                        </li>
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            <span>Wednesday</span> <span>8:00 AM - 4:00 PM</span>
                        </li>
                        <li class="list-group-item d-flex justify-content-between align-items-center bg-light">
                             <span>Thursday</span> <span>8:00 AM - 4:00 PM</span>
                        </li>
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                             <span>Friday</span> <span>8:00 AM - 4:00 PM</span>
                        </li>
                        <li class="list-group-item d-flex justify-content-between align-items-center text-muted">
                             <span>Saturday</span> <span>Closed</span>
                        </li>
                        <li class="list-group-item d-flex justify-content-between align-items-center text-muted">
                             <span>Sunday</span> <span>Closed</span>
                        </li>
                    </ul>
                </div>
            </div>

             <!-- Google Map -->
             <div class="map-container mt-4 border border-secondary shadow-sm" style="overflow:hidden; border-radius: 0.5rem;">
                 <iframe 
                     width="100%" 
                     height="300" 
                     frameborder="0" 
                     style="border:0" 
                     src="https://www.google.com/maps/embed?pb=!1m18!1m12!1m3!1d2614.471616894676!2d-124.31298868431956!3d49.31972897933544!2m3!1f0!2f0!3f0!3m2!1i1024!2i768!4f13.1!3m3!1m2!1s0x5488a15999999999%3A0x123456789abcdef!2s175%20Corfield%20St%20S%2C%20Parksville%2C%20BC%20V9P%202G1!5e0!3m2!1sen!2sca!4v1638367890000!5m2!1sen!2sca" 
                     allowfullscreen>
                 </iframe>
             </div>
        </div>

        <!-- Contact Form -->
        <div class="col-lg-7">
            <div class="card border-0 shadow-sm">
                <div class="card-body p-4">
                    <h2 class="h4 mb-4" style="color: var(--color-ocean-blue);">Request an Appointment</h2>
                    
                    @if (showSuccessMessage)
                    {
                        <div class="alert alert-success alert-dismissible fade show" role="alert">
                            <strong>✓ Message Sent!</strong> We'll contact you soon.
                            <button type="button" class="btn-close" @onclick="() => showSuccessMessage = false"></button>
                        </div>
                    }

                    @if (showErrorMessage)
                    {
                        <div class="alert alert-danger alert-dismissible fade show" role="alert">
                            <strong>✗ Error!</strong> @errorMessage
                            <button type="button" class="btn-close" @onclick="() => showErrorMessage = false"></button>
                        </div>
                    }

                    <EditForm Model="@contactForm" OnValidSubmit="HandleSubmit">
                        <DataAnnotationsValidator />
                        
                        <div class="mb-3">
                            <label for="name" class="form-label">Full Name</label>
                            <InputText @bind-Value="contactForm.Name" class="form-control" id="name" placeholder="Your Name" />
                            <ValidationMessage For="@(() => contactForm.Name)" class="text-danger small" />
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="email" class="form-label">Email Address</label>
                                <InputText @bind-Value="contactForm.Email" class="form-control" id="email" type="email" placeholder="name@example.com" />
                                <ValidationMessage For="@(() => contactForm.Email)" class="text-danger small" />
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="phone" class="form-label">Phone Number</label>
                                <InputText @bind-Value="contactForm.Phone" class="form-control" id="phone" placeholder="(250) 555-5555" />
                                <ValidationMessage For="@(() => contactForm.Phone)" class="text-danger small" />
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="message" class="form-label">Message / Preferred Time</label>
                            <InputTextArea @bind-Value="contactForm.Message" class="form-control" id="message" rows="4" placeholder="How can we help you?" />
                            <ValidationMessage For="@(() => contactForm.Message)" class="text-danger small" />
                        </div>
                        
                        <div class="text-end">
                            <button type="submit" class="btn btn-primary-custom text-white px-4 py-2" disabled="@isSubmitting">
                                @if (isSubmitting)
                                {
                                    <span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
                                    <span>Sending...</span>
                                }
                                else
                                {
                                    <span>Send Request</span>
                                }
                            </button>
                        </div>
                    </EditForm>
                </div>
            </div>
        </div>
    </div>
</div>

@code {
    private ContactFormModel contactForm = new();
    private bool isSubmitting = false;
    private bool showSuccessMessage = false;
    private bool showErrorMessage = false;
    private string errorMessage = string.Empty;

    // TODO: Replace these with your actual EmailJS credentials
    private const string EMAILJS_PUBLIC_KEY = "mXFjDQyR3cPRKqaG4";
    private const string EMAILJS_SERVICE_ID = "service_rhzwm29";
    private const string EMAILJS_TEMPLATE_ID = "template_mk7gnho"; 
    private const string EMAILJS_PATIENT_TEMPLATE_ID = "template_0tqdbe5"; 

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            try
            {
                // Initialize EmailJS
                await JS.InvokeVoidAsync("emailService.initialize", EMAILJS_PUBLIC_KEY);
            }
            catch (Exception ex)
            {
                Console.WriteLine($"Error initializing EmailJS: {ex.Message}");
            }
        }
    }

    private async Task HandleSubmit()
    {
        isSubmitting = true;
        showSuccessMessage = false;
        showErrorMessage = false;

        try
        {
            // Create form data object for JavaScript
            var formData = new
            {
                name = contactForm.Name,
                email = contactForm.Email,
                phone = contactForm.Phone ?? "",
                subject = "Contact Request", 
                message = contactForm.Message
            };

            // Send dual emails via EmailJS (admin + patient auto-reply)
            var result = await JS.InvokeAsync<EmailResult>(
                "emailService.sendContactForm",
                formData,
                EMAILJS_SERVICE_ID,
                EMAILJS_TEMPLATE_ID,
                EMAILJS_PATIENT_TEMPLATE_ID
            );

            if (result.Success)
            {
                // Success!
                showSuccessMessage = true;
                contactForm = new ContactFormModel(); // Reset form
            }
            else
            {
                showErrorMessage = true;
                errorMessage = result.Message;
            }
        }
        catch (Exception ex)
        {
            // Error
            showErrorMessage = true;
            errorMessage = "An error occurred while sending. Please try again later.";
            Console.WriteLine($"Error sending email: {ex.Message}");
        }
        finally
        {
            isSubmitting = false;
        }
    }

    // EmailResult class per ricevere risposta da JavaScript
    public class EmailResult
    {
        public bool Success { get; set; }
        public string Message { get; set; } = "";
    }
}
